# normalizr+TS

- [typescript playground](https://www.typescriptlang.org/play?#code/PTAEmg5Q7BkTtNGsGAJA9gd1AFUaAqgZwKaAyDIEIMgUQyB+DIJoMAUFQJYC2ADogE4AuoA3qDgMYAWeegEMANKAAmeAHasRAG1oAvPKGE5JMucMVKW42SwXLV60IeNLxAOW268EgMoChw0AF9QAMxaJ6oACILHWUWAIBuGhBQAFc2WkU2AE9QZMY8KjTVWzZ+WmkAc1AAXnMY+XlQAB9Y6SkvfIdIrOxpWkRpDABJaTY8FnxeeI6AHiwAPhLQAAosUDwADz66jRjpAGtZZGlQAH4Z9YAubABKEsmAN0RaCVBj6TwL-rPF5YkNaaPQfK9+0C6zsVLtdbvsundzI9+s0kulQNY8Dg+hIAIIsFjCJIjNCTUpoaqgNEYrEIpEOImY7HjcYwuEAMXkwjYyypU3xrxk73hiORFKxPz+Ez22AhDyeLFpqmcghErLx8yWnI0fJGApY2Em+wA2tLXGNxgBdCF8GXCAB0AFFerRklTIlRgAAqUAAWX6BVUuVoGha0wAQuo8Fb4skzvk2JhhNIUjF8CwALT1Rq3GQhpJmqigZ3Bv65VTrPApaTCeiqRBeVKCcx2Ewp63xRHfHYAcRk-VovDUGjcSJY+QKGazCrOLS6uD+pW4xdLx17-Y8oAAZKAA-hgzasQFY-0cAFxpnHcAqItmOxUrDVKug-WsezFSseGw+4VcVxM6AWHhhBIOvIUgB9AASVMN12Y40EiUBvgkWcn3nGppBiegACNoSodx7RaAAFDt1nXZIAGlCzlUALQWXh5BiKQRnfbgtQIptQALJJy3QA1jjIiiqLwEYGSZFlOMo6i0Hog0bEQL0X3GcTJIKSYOQfK98KxOcX2FBj7ihdV3C1ZjWLQMT3xyPJCioGlMgvUAcN4PCbxIuiGPyKzcOUojb0NDjyKEniRIIsT4Qkky5I8SVnJs5S0AvEjrNstNWQUrkxT+fYkvVY4+OZGQRhi5SqV0wtWJyuycQNcyWgAETwPBGDpfIJFynEpiKtNIvSeL70SrT332AAlPBeFYCQRlUgoDC0-coOOZqN1anzJhqabklm7KXJvZacXMiy4QixAAHUbX4NyGtfO83g0JS7LVDVuq4UB6MYrB2Nu-Kklg58Cie2wjBCFQhsazx3HfY4+oGlghpG8Q1k2FBpE26I0CrFpWJAhsNEQZC2GEZNQGQosayUec83mG9z3SDMWnw2hEWxBUzpXQNcpG6kph2-bciO4rJkXd8sDaDpul6Hd+uGaQRlZg6Obiyrqtqupjupe1ol4T8mWvNMaAqjs2F1WVTqVZ7mLe-snqhrYdncV9OHfe6nL0isDOOHXhDFrzuOxUTIbqPAGgeW4EPKeQFfQzDLL6xlkUp6m9YfOjDcfd6TY2M2PFfcqtadlbws5zaT1YDgBukJFQGVr8+mUqYaYS86Gbspnxmmd8UaSawSzwcDaf1i64quoV9jmTTxVEd9P3DhxI5wYG8FH+r6ypnAqSHk5ZxcERLU585IVQE1XDXuKcWmJuW9LcQR9VmeQznk5FbAYJ7A1yydr6rwSOjrkVR7zVCXRSlH+9-VJnblXema5a5wTUvsESAQbgBCNOBSIuczwtC+pYBwlcOrVxAXFOuUwrZQRtjsO2bFjgMSAYQxa7lhS-2fr5UqEIaGRAwvfOEfUcDlDYC-DuD537SF+OqXuX9iQjBYWw-+xowEFHtAg-OHQi63xMBXV+GC1YbmGuI6kDcoISCZMIcCQ8oLbxEI7FezscSL2OMgn6DgM7jwXqAYR8h2EbQ3nIpQ2JxA2NMXYxEIiNrTC0ZjcQBjhBXyiGAKQLiMhbVUJVCJQ1yriEcKnThb9v78h4YKT+KoYn41QVgBJzNHYEjWEmX2oVyraIwLleJ6AklAO4bwjUwotTlMxpUuyeSamwJ4MY3eKicSSIWKeaRhcODhJyRXcqySNCkl5KkkYXcVFMy1FAiQMDpKgEcFM4ByjbR1w0ZIbRxx4nviCUcipiAqn5L0cTC+iIOKz2poksxoBsnfXsHE-JG8xlvNCH47RgTjHiBRpfa+oAkCoAwNgfANApGk1UAAYT8IweQiwcGgH4IgD0RtCgLhqNwfgMQCg6PjvOTweLzBJCjNioojDjyDLznC-4KIJASE-DgDQk53zTjbiSwoDClzbNygEb8rLET4F3DnelZ4C5FxFWynA5dSgl1VrlLozLRXsvrsKll8rEQBHEJwdwIS6VDMZWOOMOCuWt2pZBNQOqxXHDVfa9lBJEIVFtcxCet1iUjXCDje4SFULaVtQNJgKKFjHERWG1F-t3XvmVbyNgZy+j8uXAs20W44wSoGaamVHBtwsEVcXFWZc7Lmv6Fqgtu4DV2o1V6uVYry5GvtCahlo5my+BiIwS1UEq2OvHCwLUBpU2CrsgEAonbGDZphVK4ZRcJ2IC7UWhNOysRdA7YuxgWqF1durbdPtd0C3KSNM2mgeba3ysdeq+VPboLHG1XWgAjPqq1M5AgYo9B+vA8ZeAbhfbS89BbH39otZyqCNx71AZfVBbl97iynhtFGaDF6xXXM9ccbgxKgjCAQ5jaQ+r-WgEfR4a5obkWLAw+izFPKAgBBI-Gkt5Ik2bxearaYJwh4AZkfmuMAAmEDE43zgZgoEAtvHkOwcCPB1giHpDieuQ29laHCxesw3BnDMm8PycI7x+jUEyPhsowSol966PuFI4x1EzGHioBaXgdjnH7Tnp3YwR1G6u23og4EAorAu3PuuQerUQHIZ8cMlxkZt1gWIhPt4hxC5SgROmC58QLnlIhKizgM0inxXLJgWablx4HmZZczgXLBozRVsK7czLVaytmk9VloAA)

## functions
- createEntity
- normalizer
- denormalizer

### createEntity
Genericに代入されたTの型から紐づくエンティティを要求し、新しいエンティティを作成する関数

```typescript
const createEntity = <T extends BaseSchema<string>>(
  entityName: string,
  relatedEntities: RelatedEntities<T>,
): schema.Entity<T> => new schema.Entity<T>(entityName, relatedEntities);
```

### normalize
第1引数にEntity型のオブジェクトを受け入れ, 第2引数にEntityの構造を定義しているオブジェクトを受け入れる。

```typescript
export const normalize = <T>(data: T, schema: Schema<T>): NormalizedSchema<Entities, Result<T>> =>
  normalize<T, Entities, Result<T>>(data, schema);
```

### denormalize
dataをセットすると代入するべきschemaを要求する関数.idとentitiesからもとのオブジェクトを逆引きする


```typescript
export const denormalize = <D extends NestArray<string>, S, T extends Entities>(
  data: D,
  schema: Entity<D, S>,
  entities: T,
): Denormalized<D, S> => denormalize(data, schema, entities);

```

## usage

### Create Entity
`src/entities`以下を見てください

```typescript
import { IUser, userEntity } from "./user";
import { createEntity, BaseEntity } from "../normalizer";

// BaseEntityのGenericにはnormalizrのnew schema.Entityの第1引数に入れていた文字列を入れてください。
export type IGroup = {
  id: string;
  users: IUser[];
} & BaseEntity<"groups">;

// IGroupに含まれるBaseEntityを含まれる型をEntityとして定義する.
export const groupEntity = createEntity<IGroup>("groups", { users: [userEntity] });
```

### Normalize
```typescript
const address: IAddress = {
  id: "address1",
  name: "hogehoge-city",
};

const user1: IUser = {
  id: "user1",
  name: "naporitan",
  address,
  keys: { a: "naporitan", b: 1 },
  complex: { hoge: "" },
};

const user2: IUser = {
  id: "user2",
  name: "naporitan2",
  address,
  keys: { a: "naporitan2", b: 2 },
  complex: { huga: "" },
};

const group: IGroup = {
  id: "gorup1",
  users: [user1, user2],
};


const { entities, result } = normalize(group, groupEntity);
// entityの塊とidの塊に分ける
console.log("result", result);
console.log("entities", JSON.stringify(entities, null, 2));
```

### Denormalize

```typescript
const { entities, result } = normalizer(group, groupEntity);
// groupオブジェクトがid: stringの形から戻る
console.log(denormalize(result, groupEntity, entities));
// groupからuserIDを引いてそれをdenormalizeしてみる
console.log(denormalize(entities.groups[result].users, [userEntity], entities));
```